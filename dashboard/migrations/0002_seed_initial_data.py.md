# Generated by Django 5.0.6 on 2024-07-25 12:01

from django.db import migrations
from django.contrib.auth.hashers import make_password


def create_initial_data(apps, schema_editor):
    """
    Creates initial data for the application, including default users and departments.
    """
    User = apps.get_model('auth', 'User')
    Department = apps.get_model('dashboard', 'Department')

    # --- Create Users ---
    # Using get_or_create to make this migration re-runnable without errors.
    admin_user, _ = User.objects.get_or_create(
        username='admin',
        defaults={
            'email': 'admin@example.com',
            'password': make_password('admin'),
            'is_superuser': True,
            'is_staff': True,
        }
    )

    demo_user, _ = User.objects.get_or_create(
        username='demo',
        defaults={
            'email': 'demo@example.com',
            'password': make_password('demo'),
            'is_staff': True,
            'is_superuser': False,
        }
    )

    # --- Create Departments ---
    hr_dept, created = Department.objects.get_or_create(
        name='Human Resources',
        owner=admin_user,
        defaults={'description': 'Handles all employee-related matters.'}
    )
    if created:
        hr_dept.members.add(admin_user, demo_user)

    eng_dept, created = Department.objects.get_or_create(
        name='Engineering',
        owner=admin_user,
        defaults={'description': 'Builds and maintains the core product.'}
    )
    if created:
        eng_dept.members.add(admin_user, demo_user)

    mkt_dept, created = Department.objects.get_or_create(
        name='Marketing',
        owner=admin_user,
        defaults={'description': 'Manages product promotion and customer outreach.'}
    )
    if created:
        mkt_dept.members.add(admin_user)


class Migration(migrations.Migration):

    dependencies = [
        ('dashboard', '0001_initial'),
        ('auth', '0012_alter_user_first_name_max_length'),  # Dependency on latest auth migration
    ]

    operations = [
        migrations.RunPython(create_initial_data),
    ]
